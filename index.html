{% extends 'game/base.html' %}

{% block content %}
<div class="game-container">
    <div class="title">Baseball Name Game</div>
    
    <div class="instructions" id="instructions">Press Start to begin</div>
    
    <div class="player-name" id="current-player"></div>
    
    <div class="score" id="score">Score: 0</div>
    
    <div class="result" id="result"></div>
    
    <div class="buttons">
        <button id="start-button" class="btn">Start Game</button>
        <button id="rules-button" class="btn">Show Rules</button>
    </div>
    
    <div class="timer" id="timer">Time: 10</div>
</div>

<!-- Rules Modal -->
<div class="modal fade" id="rulesModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Game Rules</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="rules-content"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let gameInterval;
let timeLeft = 10;
let isListening = false;
let rulesModal;
let lastUpdate = Date.now();

$(document).ready(function() {
    rulesModal = new bootstrap.Modal(document.getElementById('rulesModal'));
    
    $('#start-button').click(startGame);
    $('#rules-button').click(showRules);
    
    // Check microphone availability
    checkMicrophone();
});

function updateTimer() {
    const now = Date.now();
    const delta = now - lastUpdate;
    lastUpdate = now;
    
    timeLeft -= delta / 1000;
    $('#timer').text(`Time: ${Math.ceil(timeLeft)}`);
    
    if (timeLeft <= 0) {
        endGame();
    }
}

function startGame() {
    $.get('/start_game/', function(response) {
        $('#current-player').text(response.current_player);
        $('#instructions').text(`Say a player whose first name starts with '${response.required_letter}'!`);
        timeLeft = 10;
        lastUpdate = Date.now();
        $('#timer').text('Time: 10');
        $('#score').text('Score: 0');
        startListening();
        gameInterval = setInterval(updateTimer, 16); // ~60fps for smoother timer
    });
}

function startListening() {
    if (isListening) return;
    
    isListening = true;
    $('#instructions').text('Listening...');
    
    $.ajax({
        url: '/start_speech/',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({}),
        success: function(response) {
            if (response.success) {
                checkAnswer(response.spoken_name);
            } else {
                showResult('Could not understand audio. Please try again.', 'error');
            }
        },
        error: function(xhr) {
            showResult(xhr.responseJSON.message, 'error');
        },
        complete: function() {
            isListening = false;
            startListening(); // Continue listening
        }
    });
}

function checkAnswer(answer) {
    $.ajax({
        url: '/check_answer/',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ answer: answer }),
        success: function(response) {
            if (response.correct) {
                if (response.game_over) {
                    clearInterval(gameInterval);
                    showResult(response.message, 'success');
                    setTimeout(startGame, 3000);
                } else {
                    $('#current-player').text(response.current_player);
                    $('#instructions').text(`Say a player whose first name starts with '${response.required_letter}'!`);
                    $('#score').text(`Score: ${response.score}`);
                    timeLeft = response.time_left;
                    lastUpdate = Date.now();
                    showResult(response.message, 'success');
                }
            } else {
                showResult(response.message, 'error');
            }
        }
    });
}

function showResult(message, type) {
    const result = $('#result');
    result.text(message);
    result.removeClass('success error').addClass(type);
    setTimeout(() => result.text(''), 3000);
}

function endGame() {
    clearInterval(gameInterval);
    isListening = false;
    const score = parseInt($('#score').text().split(': ')[1]);
    $('#current-player').text('Game Over!');
    $('#instructions').text('Press Start to begin');
    showResult(`Game Over! Final Score: ${score}`, 'info');
}

function showRules() {
    $.get('/show_rules/', function(response) {
        $('#rules-content').html(response.rules.replace(/\n/g, '<br>'));
        rulesModal.show();
    });
}

function checkMicrophone() {
    $.get('/check_microphone/', function(response) {
        if (!response.available) {
            showResult('Microphone not available. Voice input disabled.', 'error');
        }
    });
}
</script>
{% endblock %} 