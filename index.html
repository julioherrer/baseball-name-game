{% extends 'game/base.html' %}

{% block content %}
<div class="game-container">
    <div class="timer" id="timer">10</div>
    <div class="score" id="score">0</div>
    
    <h2 id="current-player">Ready to Play?</h2>

    <form id="answer-form" class="d-none">
        <div class="input-group">
            <input type="text" class="form-control" id="answer" placeholder="Enter player name..." autocomplete="off">
            <button class="btn btn-primary" type="submit">Submit</button>
        </div>
        <div class="text-center mt-2">
            <button type="button" class="btn btn-info" id="speak-button">
                <i class="fas fa-microphone"></i> Speak Name
            </button>
        </div>
    </form>

    <div class="text-center">
        <button id="start-button" class="btn btn-success">Start Game</button>
        <button id="rules-button" class="btn btn-secondary">Show Rules</button>
    </div>

    <div id="alert" class="alert"></div>

    <div class="high-scores">
        <h4 class="text-center mb-2">High Scores</h4>
        <div class="table-responsive">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>Player</th>
                        <th>Score</th>
                    </tr>
                </thead>
                <tbody>
                    {% for name, score in high_scores %}
                    <tr>
                        <td>{{ name }}</td>
                        <td>{{ score }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Rules Modal -->
<div class="modal fade" id="rulesModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Game Rules</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="rules-content"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let gameInterval;
let timeLeft = 10;
let isListening = false;
let rulesModal;
let lastUpdate = Date.now();

$(document).ready(function() {
    rulesModal = new bootstrap.Modal(document.getElementById('rulesModal'));
    
    $('#start-button').click(startGame);
    $('#rules-button').click(showRules);
    
    $('#answer-form').submit(function(e) {
        e.preventDefault();
        const answer = $('#answer').val().trim();
        if (answer) {
            checkAnswer(answer);
        }
    });

    $('#speak-button').click(startSpeechRecognition);
    
    // Check microphone availability
    checkMicrophone();
});

function updateTimer() {
    const now = Date.now();
    const delta = now - lastUpdate;
    lastUpdate = now;
    
    timeLeft -= delta / 1000;
    $('#timer').text(Math.ceil(timeLeft));
    
    if (timeLeft <= 0) {
        endGame();
    }
}

function startGame() {
    $.get('/start_game/', function(response) {
        $('#current-player').text(response.current_player);
        $('#answer-form').removeClass('d-none');
        $('#start-button').addClass('d-none');
        $('#rules-button').addClass('d-none');
        timeLeft = 10;
        lastUpdate = Date.now();
        $('#timer').text(timeLeft);
        $('#score').text('0');
        gameInterval = setInterval(updateTimer, 16); // ~60fps for smoother timer
    });
}

function checkAnswer(answer, isSpeech = false) {
    $.ajax({
        url: '/check_answer/',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            answer: answer,
            is_speech: isSpeech
        }),
        success: function(response) {
            if (response.correct) {
                $('#current-player').text(response.current_player);
                $('#score').text(response.score);
                $('#answer').val('');
                timeLeft = response.time_left;
                lastUpdate = Date.now();
                $('#timer').text(timeLeft);
                showAlert('Correct! Well done!', 'success');
            } else {
                showAlert('Incorrect. Try again!', 'danger');
            }
        },
        error: function(xhr) {
            showAlert('Error: ' + xhr.responseJSON.message, 'danger');
        }
    });
}

function startSpeechRecognition() {
    if (isListening) {
        return;
    }

    isListening = true;
    $('#speak-button').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Listening...');

    $.ajax({
        url: '/start_speech/',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({}),
        success: function(response) {
            if (response.success) {
                $('#answer').val(response.spoken_name);
                checkAnswer(response.spoken_name, true);
            } else {
                showAlert('Could not understand audio. Please try again.', 'warning');
            }
        },
        error: function(xhr) {
            showAlert('Error: ' + xhr.responseJSON.message, 'danger');
        },
        complete: function() {
            isListening = false;
            $('#speak-button').prop('disabled', false).html('<i class="fas fa-microphone"></i> Speak Name');
        }
    });
}

function showAlert(message, type) {
    const alert = $('#alert');
    alert.removeClass().addClass(`alert alert-${type}`);
    alert.text(message).show();
    setTimeout(() => alert.fadeOut(), 3000);
}

function endGame() {
    clearInterval(gameInterval);
    $('#answer-form').addClass('d-none');
    $('#start-button').removeClass('d-none');
    $('#rules-button').removeClass('d-none');
    $('#current-player').text('Game Over!');
    
    const score = parseInt($('#score').text());
    const playerName = prompt('Enter your name for the high score:', 'Anonymous');
    
    if (playerName) {
        $.ajax({
            url: '/save_score/',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                player_name: playerName,
                score: score
            }),
            success: function(response) {
                if (response.success) {
                    location.reload(); // Refresh to show updated high scores
                }
            }
        });
    }
    
    showAlert(`Game Over! Your final score: ${score}`, 'info');
}

function showRules() {
    $.get('/show_rules/', function(response) {
        $('#rules-content').html(response.rules.replace(/\n/g, '<br>'));
        rulesModal.show();
    });
}

function checkMicrophone() {
    $.get('/check_microphone/', function(response) {
        if (!response.available) {
            $('#speak-button').prop('disabled', true);
            showAlert('Microphone not available. Voice input disabled.', 'warning');
        }
    });
}
</script>
{% endblock %} 