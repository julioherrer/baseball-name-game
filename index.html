<!DOCTYPE html>
<html>
<head>
    <title>Baseball Name Game</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f2f2f7;
            color: #000;
            -webkit-font-smoothing: antialiased;
        }
        .game-container {
            max-width: 414px;
            margin: 0 auto;
            padding: 20px;
            background-color: #fff;
            min-height: 100vh;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .game-header {
            text-align: center;
            padding: 20px 0;
            border-bottom: 1px solid #e5e5ea;
        }
        .game-header h1 {
            font-size: 28px;
            font-weight: 700;
            margin: 0;
            color: #000;
        }
        .game-status {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 12px;
            margin: 20px 0;
        }
        .status-item {
            text-align: center;
            padding: 15px;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .status-label {
            font-size: 14px;
            color: #8e8e93;
            margin-bottom: 5px;
            font-weight: 500;
        }
        .status-value {
            font-size: 24px;
            font-weight: 600;
            color: #000;
        }
        .controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 20px;
        }
        .btn {
            padding: 16px;
            font-size: 17px;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            width: 100%;
        }
        .btn-primary {
            background-color: #007aff;
            color: white;
        }
        .btn-primary:hover {
            background-color: #0066cc;
        }
        .btn-danger {
            background-color: #ff3b30;
            color: white;
        }
        .btn-danger:hover {
            background-color: #cc2f26;
        }
        .rules {
            margin: 20px;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 12px;
        }
        .rules h3 {
            font-size: 20px;
            font-weight: 600;
            margin: 0 0 15px 0;
            color: #000;
        }
        .rules ul {
            margin: 0;
            padding-left: 20px;
        }
        .rules li {
            margin: 10px 0;
            font-size: 16px;
            color: #3c3c43;
            line-height: 1.4;
        }
        #recordButton {
            display: none;
        }
        .message {
            text-align: center;
            margin: 15px 20px;
            padding: 15px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 500;
        }
        .message.success {
            background-color: #e3fcef;
            color: #007a3d;
        }
        .message.error {
            background-color: #ffe5e5;
            color: #cc2f26;
        }
        .timer-container {
            text-align: center;
            margin: 20px 0;
        }
        .timer {
            font-size: 48px;
            font-weight: 700;
            color: #000;
        }
        .timer-label {
            font-size: 14px;
            color: #8e8e93;
            margin-top: 5px;
        }
        @media (max-width: 414px) {
            .game-container {
                padding: 0;
            }
            .game-status {
                margin: 10px;
            }
            .controls {
                padding: 10px;
            }
            .rules {
                margin: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="game-header">
            <h1>Baseball Name Game</h1>
        </div>
        
        <div class="game-status">
            <div class="status-item">
                <div class="status-label">Current Player</div>
                <div class="status-value" id="currentPlayer">-</div>
            </div>
            <div class="status-item">
                <div class="status-label">Required Letter</div>
                <div class="status-value" id="requiredLetter">-</div>
            </div>
            <div class="status-item">
                <div class="status-label">Score</div>
                <div class="status-value" id="score">0</div>
            </div>
            <div class="status-item">
                <div class="status-label">Time Left</div>
                <div class="status-value" id="timeLeft">10</div>
            </div>
        </div>

        <div class="timer-container">
            <div class="timer" id="timerDisplay">10</div>
            <div class="timer-label">seconds remaining</div>
        </div>

        <div class="controls">
            <button class="btn btn-primary" id="startButton">Start Game</button>
            <button class="btn btn-danger" id="recordButton">Start Recording</button>
        </div>

        <div id="message" class="message"></div>

        <div class="rules">
            <h3>Game Rules</h3>
            <ul>
                <li>Say the name of an MLB player when prompted</li>
                <li>The player's name must start with the last letter of the previous player's name</li>
                <li>You have 10 seconds to name as many players as possible</li>
                <li>Each correct answer adds 1 point to your score</li>
                <li>The game ends when you run out of time or can't think of another valid player</li>
            </ul>
        </div>
    </div>

    <script>
        const gameState = {
            currentPlayer: null,
            score: 0,
            timeLeft: 10,
            isRunning: false,
            requiredLetter: "",
            recognizedText: "",
            gameOver: false,
            mediaRecorder: null,
            audioChunks: [],
            timer: null
        };

        const startButton = document.getElementById('startButton');
        const recordButton = document.getElementById('recordButton');
        const currentPlayerDisplay = document.getElementById('currentPlayer');
        const requiredLetterDisplay = document.getElementById('requiredLetter');
        const scoreDisplay = document.getElementById('score');
        const timeLeftDisplay = document.getElementById('timeLeft');
        const timerDisplay = document.getElementById('timerDisplay');
        const messageDisplay = document.getElementById('message');

        startButton.addEventListener('click', startGame);
        recordButton.addEventListener('click', toggleRecording);

        function startGame() {
            // Reset game state
            gameState.currentPlayer = null;
            gameState.score = 0;
            gameState.timeLeft = 10;
            gameState.isRunning = false;
            gameState.requiredLetter = "";
            gameState.recognizedText = "";
            gameState.gameOver = false;
            
            // Update display
            updateDisplay();
            
            fetch('/start_game/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    gameState.currentPlayer = data.player;
                    gameState.score = data.score;
                    gameState.timeLeft = data.time_left;
                    gameState.requiredLetter = data.required_letter;
                    gameState.isRunning = true;
                    gameState.gameOver = false;

                    updateDisplay();
                    startButton.style.display = 'none';
                    recordButton.style.display = 'block';
                    startTimer();
                    showMessage(data.message, 'success');
                } else {
                    showMessage(data.message || 'Failed to start game', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('Failed to start game. Please try again.', 'error');
            });
        }

        function updateDisplay() {
            currentPlayerDisplay.textContent = gameState.currentPlayer || '-';
            requiredLetterDisplay.textContent = gameState.requiredLetter || '-';
            scoreDisplay.textContent = gameState.score;
            updateTimerDisplay();
        }

        function startTimer() {
            // Clear any existing timer
            if (gameState.timer) {
                clearInterval(gameState.timer);
            }
            
            // Update display immediately
            updateTimerDisplay();
            
            // Start the interval timer
            gameState.timer = setInterval(() => {
                if (gameState.timeLeft > 0) {
                    gameState.timeLeft--;
                    updateTimerDisplay();
                } else {
                    endGame();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            timerDisplay.textContent = gameState.timeLeft;
            timeLeftDisplay.textContent = gameState.timeLeft;
            
            // Visual feedback for low time
            if (gameState.timeLeft <= 5) {
                timerDisplay.style.color = '#ff3b30';
            } else {
                timerDisplay.style.color = '#000';
            }
        }

        function endGame() {
            clearInterval(gameState.timer);
            gameState.isRunning = false;
            gameState.gameOver = true;
            recordButton.style.display = 'none';
            startButton.style.display = 'block';
            startButton.textContent = 'Play Again';
            showMessage(`Game Over! Your final score is ${gameState.score}`, 'success');
            
            // Reset timer display color
            timerDisplay.style.color = '#000';
        }

        function toggleRecording() {
            if (!gameState.isRunning || gameState.gameOver) return;

            if (!gameState.mediaRecorder) {
                startRecording();
            } else {
                stopRecording();
            }
        }

        function startRecording() {
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    gameState.mediaRecorder = new MediaRecorder(stream);
                    gameState.audioChunks = [];

                    gameState.mediaRecorder.ondataavailable = (event) => {
                        gameState.audioChunks.push(event.data);
                    };

                    gameState.mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(gameState.audioChunks, { type: 'audio/wav' });
                        sendAudioForRecognition(audioBlob);
                    };

                    gameState.mediaRecorder.start();
                    recordButton.textContent = 'Stop Recording';
                    showMessage('Recording...', 'success');
                })
                .catch(error => {
                    console.error('Error accessing microphone:', error);
                    showMessage('Error accessing microphone. Please check permissions.', 'error');
                });
        }

        function stopRecording() {
            if (gameState.mediaRecorder && gameState.mediaRecorder.state !== 'inactive') {
                gameState.mediaRecorder.stop();
                recordButton.textContent = 'Start Recording';
                showMessage('Processing...', 'success');
            }
        }

        function sendAudioForRecognition(audioBlob) {
            const formData = new FormData();
            formData.append('audio', audioBlob);

            fetch('/start_recognition/', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    checkAnswer(data.recognized_text);
                } else {
                    showMessage(data.error || 'Error processing audio', 'error');
                }
            })
            .catch(error => {
                console.error('Error sending audio:', error);
                showMessage('Error processing audio. Please try again.', 'error');
            });
        }

        function checkAnswer(recognizedText) {
            if (!gameState.isRunning || gameState.gameOver) return;

            fetch('/check_answer/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    answer: recognizedText
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (data.correct) {
                        gameState.score = data.score;
                        if (data.game_over) {
                            endGame(data.message);
                        } else {
                            gameState.currentPlayer = data.player;
                            gameState.requiredLetter = data.required_letter;
                            updateDisplay();
                            showMessage(data.message, 'success');
                        }
                    } else {
                        showMessage(data.message, 'error');
                    }
                } else {
                    showMessage(data.message || 'Error checking answer', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('Error checking answer', 'error');
            });
        }

        function endGame(message) {
            clearInterval(gameState.timer);
            gameState.isRunning = false;
            gameState.gameOver = true;
            recordButton.style.display = 'none';
            startButton.style.display = 'block';
            startButton.textContent = 'Play Again';
            showMessage(message || `Game Over! Your final score is ${gameState.score}`, 'success');
            
            // Reset timer display color
            timerDisplay.style.color = '#000';
        }

        function showMessage(message, type) {
            messageDisplay.textContent = message;
            messageDisplay.className = 'message ' + type;
            // Clear message after 3 seconds
            setTimeout(() => {
                messageDisplay.textContent = '';
                messageDisplay.className = 'message';
            }, 3000);
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
</body>
</html> 