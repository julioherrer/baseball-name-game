{% extends 'game/base.html' %}

{% block content %}
<div class="game-container text-center">
    <h1 class="mb-4">Baseball Name Game</h1>
    
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="timer" id="timer">60</div>
            <div>Time Left</div>
        </div>
        <div class="col-md-6">
            <div class="score" id="score">0</div>
            <div>Score</div>
        </div>
    </div>

    <div class="mb-4">
        <h2 id="current-player" class="display-4">Ready to Play?</h2>
    </div>

    <div class="mb-4">
        <form id="answer-form" class="d-none">
            <div class="input-group mb-3">
                <input type="text" class="form-control form-control-lg" id="answer" placeholder="Enter player name..." autocomplete="off">
                <button class="btn btn-primary btn-lg" type="submit">Submit</button>
            </div>
            <div class="mt-3">
                <button type="button" class="btn btn-info btn-lg" id="speak-button">
                    <i class="fas fa-microphone"></i> Speak Name
                </button>
            </div>
        </form>
    </div>

    <div>
        <button id="start-button" class="btn btn-success btn-lg">Start Game</button>
    </div>

    <div id="alert" class="alert mt-3" style="display: none;"></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let gameInterval;
let timeLeft = 60;
let isListening = false;

function updateTimer() {
    timeLeft--;
    $('#timer').text(timeLeft);
    if (timeLeft <= 0) {
        endGame();
    }
}

function startGame() {
    $.get('/start_game/', function(response) {
        $('#current-player').text(response.current_player);
        $('#answer-form').removeClass('d-none');
        $('#start-button').addClass('d-none');
        timeLeft = 60;
        $('#timer').text(timeLeft);
        $('#score').text('0');
        gameInterval = setInterval(updateTimer, 1000);
    });
}

function checkAnswer(answer, isSpeech = false) {
    $.ajax({
        url: '/check_answer/',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            answer: answer,
            is_speech: isSpeech
        }),
        success: function(response) {
            if (response.correct) {
                $('#current-player').text(response.current_player);
                $('#score').text(response.score);
                $('#answer').val('');
                showAlert('Correct! Well done!', 'success');
            } else {
                showAlert('Incorrect. Try again!', 'danger');
            }
        },
        error: function(xhr) {
            showAlert('Error: ' + xhr.responseJSON.message, 'danger');
        }
    });
}

function startSpeechRecognition() {
    if (isListening) {
        return;
    }

    isListening = true;
    $('#speak-button').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Listening...');

    $.ajax({
        url: '/start_speech/',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({}),
        success: function(response) {
            if (response.success) {
                $('#answer').val(response.spoken_name);
                checkAnswer(response.spoken_name, true);
            } else {
                showAlert('Could not understand audio. Please try again.', 'warning');
            }
        },
        error: function(xhr) {
            showAlert('Error: ' + xhr.responseJSON.message, 'danger');
        },
        complete: function() {
            isListening = false;
            $('#speak-button').prop('disabled', false).html('<i class="fas fa-microphone"></i> Speak Name');
        }
    });
}

function showAlert(message, type) {
    const alert = $('#alert');
    alert.removeClass().addClass(`alert alert-${type} mt-3`);
    alert.text(message).show();
    setTimeout(() => alert.fadeOut(), 3000);
}

function endGame() {
    clearInterval(gameInterval);
    $('#answer-form').addClass('d-none');
    $('#start-button').removeClass('d-none');
    $('#current-player').text('Game Over!');
    showAlert(`Game Over! Your final score: ${$('#score').text()}`, 'info');
}

$(document).ready(function() {
    $('#start-button').click(startGame);
    
    $('#answer-form').submit(function(e) {
        e.preventDefault();
        const answer = $('#answer').val().trim();
        if (answer) {
            checkAnswer(answer);
        }
    });

    $('#speak-button').click(startSpeechRecognition);
});
</script>
{% endblock %} 